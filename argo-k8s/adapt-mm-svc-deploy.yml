apiVersion: argoproj.io/v1alpha1
kind: Workflow                  #new type of k8s spec
metadata:
  generateName: nlp-adapt-wf-    #name of workflow spec
spec:
  entrypoint: nlp-adapt-metamap-services          #invoke the build template
  
  templates:

  - name: nlp-adapt-metamap-services
    steps:
    - - name: mmserver-deployment
        template: mmserver-server-d
    - - name: mmserver-service
        template: mmserver-server-s
  
  - name: mmserver-server-d
    resource:
      action: create
      manifest: |
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: mmserver
        spec:
          selector:
            matchLabels:
              app: mmserver
              track: stable
          template:
            metadata:
              labels:
                app: mmserver
                track: stable
          
            spec:
                #nodeSelector:
                #dns: dns1
              containers:
              - image: ahc-nlpie-docker.artifactory.umn.edu/mmserver
                imagePullPolicy: Never
                name: mmserver
                ports:
                - containerPort: 8066
                env:
                - name: TAGGER_SERVER_HOSTS 
                  value: medpost.default
                - name: WSD_SERVER_HOSTS
                  value: wsd.default

  - name: mmserver-server-s
    resource:
      action: create
      manifest: |
        apiVersion: v1
        kind: Service
        metadata:
          name: mmserver
          namespace: default
          labels:
            app: mmserver

        spec:
          selector:
            app: mmserver
          ports:
          - port: 8066
            targetPort: 8066

       
